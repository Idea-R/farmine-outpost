---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import AdminNav from '../../components/AdminNav.astro';
import { supabase } from '../../lib/supabase';

// Get optional filter from query params
const url = new URL(Astro.request.url);
const filterAgent = url.searchParams.get('agent') || '';
const filterType = url.searchParams.get('type') || '';
const page = parseInt(url.searchParams.get('page') || '1');
const perPage = 50;

let query = supabase.from('cycle_log').select('*', { count: 'exact' }).order('created_at', { ascending: false });
if (filterAgent) query = query.eq('agent_id', filterAgent);
if (filterType) query = query.eq('cycle_type', filterType);
query = query.range((page - 1) * perPage, page * perPage - 1);

const { data: logs, count: totalCount } = await query;
const totalPages = Math.ceil((totalCount || 0) / perPage);

const [{ data: agents }, { data: cycleTypes }] = await Promise.all([
  supabase.from('agent_souls').select('agent_id, dwarven_name').order('agent_id'),
  supabase.from('cycle_log').select('cycle_type'),
]);
const uniqueCycleTypes = [...new Set((cycleTypes || []).map(c => c.cycle_type))].sort();

function buildQs(overrides: Record<string, string> = {}) {
  const params = new URLSearchParams();
  const a = overrides.agent ?? filterAgent;
  const t = overrides.type ?? filterType;
  const p = overrides.page ?? String(page);
  if (a) params.set('agent', a);
  if (t) params.set('type', t);
  if (p !== '1') params.set('page', p);
  const qs = params.toString();
  return qs ? `?${qs}` : '';
}

function timeAgo(dateStr: string) {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}

const agentEmojis: Record<string, string> = {
  alpha: 'ğŸ—ï¸', beta: 'ğŸŒ', gamma: 'âš”ï¸', delta: 'ğŸ”§',
  epsilon: 'ğŸ“–', zeta: 'ğŸµ', eta: 'ğŸ¨', theta: 'ğŸº', dev_master: 'ğŸ‘ï¸'
};
---

<Layout title="Activity Feed â€” The Far Mine Admin">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <AdminNav current="activity" title="ğŸ“‹ Activity Feed" subtitle="Agent reasoning and cycle decisions" />

    <!-- Filters -->
    <div class="flex items-center gap-3 mb-4 flex-wrap">
      <a href="/admin/activity" class={`text-xs px-3 py-1.5 rounded border transition-all ${!filterAgent && !filterType ? 'border-copper text-gold bg-mine-stone' : 'border-copper-dark/30 text-copper-dark hover:border-copper/50'}`}>All</a>
      {(agents || []).map(a => (
        <a href={`/admin/activity${buildQs({ agent: a.agent_id, page: '1' })}`} class={`text-xs px-3 py-1.5 rounded border transition-all ${filterAgent === a.agent_id ? 'border-copper text-gold bg-mine-stone' : 'border-copper-dark/30 text-copper-dark hover:border-copper/50'}`}>
          {agentEmojis[a.agent_id] || 'ğŸ¤–'} {a.agent_id}
        </a>
      ))}
    </div>
    <div class="flex items-center gap-3 mb-6 flex-wrap">
      <span class="text-xs text-copper-dark">Cycle type:</span>
      <a href={`/admin/activity${buildQs({ type: '', page: '1' })}`}
         class={`text-xs px-2 py-1 rounded border transition-all ${!filterType ? 'border-copper text-gold bg-mine-stone' : 'border-copper-dark/30 text-copper-dark hover:border-copper/50'}`}>All</a>
      {uniqueCycleTypes.map(ct => (
        <a href={`/admin/activity${buildQs({ type: ct, page: '1' })}`}
           class={`text-xs px-2 py-1 rounded border transition-all ${filterType === ct ? 'border-copper text-gold bg-mine-stone' : 'border-copper-dark/30 text-copper-dark hover:border-copper/50'}`}>
          {ct}
        </a>
      ))}
      <span class="text-xs text-copper-dark/40 ml-auto">{totalCount || 0} entries</span>
    </div>

    <!-- Log entries -->
    <div class="space-y-2">
      {(!logs || logs.length === 0) ? (
        <div class="card p-8 text-center">
          <p class="text-copper-dark">No cycle data found{filterAgent ? ` for ${filterAgent}` : ''}.</p>
        </div>
      ) : logs.map(log => (
        <div class="card p-4">
          <div class="flex items-center gap-3 mb-2">
            <span class="text-sm">{agentEmojis[log.agent_id] || 'ğŸ¤–'}</span>
            <span class="font-heading text-sm text-copper">{log.agent_id}</span>
            <span class="badge bg-mine-shaft text-copper-dark border border-copper-dark/30 text-[10px]">{log.cycle_type}</span>
            <span class="badge bg-mine-deep text-copper border border-copper-dark/20 text-[10px]">{log.action}</span>
            {log.model_used && <span class="text-[10px] text-copper-dark/50 font-mono">{log.model_used}</span>}
            <span class="text-xs text-copper-dark/40 ml-auto">{timeAgo(log.created_at)}</span>
          </div>
          {log.reasoning && (
            <p class="text-sm text-copper-light/80 mb-1">{log.reasoning}</p>
          )}
          {log.result_summary && (
            <p class="text-xs text-copper-dark/60">{log.result_summary}</p>
          )}
        </div>
      ))}
    </div>

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="flex items-center justify-center gap-2 mt-8">
        {page > 1 && (
          <a href={`/admin/activity${buildQs({ page: String(page - 1) })}`}
             class="text-sm text-copper hover:text-gold px-3 py-1 card-hover">â† Prev</a>
        )}
        <span class="text-xs text-copper-dark">Page {page} of {totalPages}</span>
        {page < totalPages && (
          <a href={`/admin/activity${buildQs({ page: String(page + 1) })}`}
             class="text-sm text-copper hover:text-gold px-3 py-1 card-hover">Next â†’</a>
        )}
      </div>
    )}
  </div>
</Layout>
