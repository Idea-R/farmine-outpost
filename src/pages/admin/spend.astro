---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { getApiSpend } from '../../lib/supabase';

// Auth is handled by middleware ‚Äî if we're here, user is authenticated.

const now = new Date();
const todayStart = new Date(now); todayStart.setHours(0,0,0,0);
const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
const monthStart = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

const [todayData, weekData, monthData] = await Promise.all([
  getApiSpend(todayStart.toISOString()),
  getApiSpend(weekStart.toISOString()),
  getApiSpend(monthStart.toISOString()),
]);

function aggregate(data: any[]) {
  const total = data.reduce((s, r) => s + (r.estimated_cost || 0), 0);
  const calls = data.length;
  const tokens = data.reduce((s, r) => s + (r.input_tokens || 0) + (r.output_tokens || 0), 0);

  const byAgent: Record<string, { cost: number; calls: number }> = {};
  const byModel: Record<string, { cost: number; calls: number }> = {};

  for (const r of data) {
    if (!byAgent[r.agent_id]) byAgent[r.agent_id] = { cost: 0, calls: 0 };
    byAgent[r.agent_id].cost += r.estimated_cost || 0;
    byAgent[r.agent_id].calls += 1;

    if (!byModel[r.model]) byModel[r.model] = { cost: 0, calls: 0 };
    byModel[r.model].cost += r.estimated_cost || 0;
    byModel[r.model].calls += 1;
  }

  return { total, calls, tokens, byAgent, byModel };
}

const today = aggregate(todayData);
const week = aggregate(weekData);
const month = aggregate(monthData);

const dailyTotals: Record<string, number> = {};
for (const r of monthData) {
  const dateKey = r.created_at.substring(0, 10);
  dailyTotals[dateKey] = (dailyTotals[dateKey] || 0) + (r.estimated_cost || 0);
}
const dailyEntries = Object.entries(dailyTotals).sort((a, b) => a[0].localeCompare(b[0]));

function sortedEntries(obj: Record<string, { cost: number; calls: number }>) {
  return Object.entries(obj).sort((a, b) => b[1].cost - a[1].cost);
}
---

<Layout title="API Spend ‚Äî The Far Mine Admin">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-display text-gold glow-text">üí∞ API Spend Dashboard</h1>
        <p class="text-copper-dark text-sm mt-1">Real-time cost tracking for the agent orchestra</p>
      </div>
      <a href="/admin" class="text-sm text-copper hover:text-gold transition-colors">‚Üê Dashboard</a>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-12">
      <div class="card p-5 text-center">
        <div class="text-sm text-copper-dark mb-1">Today</div>
        <div class={`text-3xl font-heading ${today.total > 5 ? 'text-forge-fire' : today.total > 1 ? 'text-copper' : 'text-gold'}`}>
          ${today.total.toFixed(4)}
        </div>
        <div class="text-xs text-copper-dark/60 mt-1">{today.calls} calls ¬∑ {today.tokens.toLocaleString()} tokens</div>
      </div>
      <div class="card p-5 text-center">
        <div class="text-sm text-copper-dark mb-1">This Week</div>
        <div class="text-3xl font-heading text-gold">${week.total.toFixed(4)}</div>
        <div class="text-xs text-copper-dark/60 mt-1">{week.calls} calls</div>
      </div>
      <div class="card p-5 text-center">
        <div class="text-sm text-copper-dark mb-1">This Month</div>
        <div class="text-3xl font-heading text-gold">${month.total.toFixed(4)}</div>
        <div class="text-xs text-copper-dark/60 mt-1">{month.calls} calls</div>
      </div>
    </div>

    <!-- Daily Spend Chart -->
    <h2 class="text-2xl font-heading text-gold mb-4">üìä Daily Spend (30 days)</h2>
    <div class="card p-4 mb-12 overflow-x-auto">
      {dailyEntries.length === 0 ? (
        <p class="text-copper-dark text-center py-4">No spend data yet.</p>
      ) : (
        <div class="space-y-1 font-mono text-xs">
          {dailyEntries.map(([date, cost]) => {
            const maxCost = Math.max(...dailyEntries.map(e => e[1]));
            const barWidth = maxCost > 0 ? Math.max(1, Math.round((cost / maxCost) * 40)) : 0;
            const bar = '‚ñà'.repeat(barWidth);
            return (
              <div class="flex items-center gap-2">
                <span class="text-copper-dark/60 w-20 shrink-0">{date.substring(5)}</span>
                <span class="text-gold">{bar}</span>
                <span class="text-copper-light">${cost.toFixed(4)}</span>
              </div>
            );
          })}
        </div>
      )}
    </div>

    <!-- By Agent / By Model -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
      <div>
        <h2 class="text-2xl font-heading text-gold mb-4">ü§ñ By Agent (Today)</h2>
        <div class="card p-4">
          {sortedEntries(today.byAgent).length === 0 ? (
            <p class="text-copper-dark text-center py-4">No data</p>
          ) : (
            <div class="space-y-2">
              {sortedEntries(today.byAgent).map(([id, d]) => (
                <div class="flex items-center justify-between text-sm">
                  <span class="font-mono text-copper-light">{id}</span>
                  <div class="text-right">
                    <span class="text-gold">${d.cost.toFixed(4)}</span>
                    <span class="text-copper-dark/60 text-xs ml-2">({d.calls} calls)</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      <div>
        <h2 class="text-2xl font-heading text-gold mb-4">‚öôÔ∏è By Model (Today)</h2>
        <div class="card p-4">
          {sortedEntries(today.byModel).length === 0 ? (
            <p class="text-copper-dark text-center py-4">No data</p>
          ) : (
            <div class="space-y-2">
              {sortedEntries(today.byModel).map(([m, d]) => (
                <div class="flex items-center justify-between text-sm">
                  <span class="font-mono text-copper-light">{m}</span>
                  <div class="text-right">
                    <span class="text-gold">${d.cost.toFixed(4)}</span>
                    <span class="text-copper-dark/60 text-xs ml-2">({d.calls} calls)</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>

    <!-- Recent Calls -->
    <h2 class="text-2xl font-heading text-gold mb-4">üìã Recent API Calls</h2>
    <div class="card p-4 overflow-x-auto">
      {todayData.length === 0 ? (
        <p class="text-copper-dark text-center py-4">No calls today.</p>
      ) : (
        <div class="space-y-1">
          {todayData.slice(0, 50).map((r: any) => (
            <div class="flex items-center justify-between text-xs font-mono py-1 border-b border-copper-dark/10 last:border-0">
              <div class="flex items-center gap-3">
                <span class="text-copper-dark/50 w-16 shrink-0">{r.created_at.substring(11, 19)}</span>
                <span class="text-gold w-20 shrink-0">{r.agent_id}</span>
                <span class="text-copper-light">{r.call_type}</span>
              </div>
              <div class="flex items-center gap-4">
                <span class="text-copper-dark">{r.model}</span>
                <span class="text-copper-dark/60">{((r.input_tokens || 0) + (r.output_tokens || 0)).toLocaleString()} tok</span>
                <span class="text-gold">${(r.estimated_cost || 0).toFixed(4)}</span>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  </div>
</Layout>
