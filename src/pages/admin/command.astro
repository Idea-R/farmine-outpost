---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

// Fetch recent prompts for history
const { data: recentPrompts } = await supabase
  .from('admin_commands')
  .select('id, params, status, result, created_at, executed_at')
  .eq('command', 'prompt')
  .order('created_at', { ascending: false })
  .limit(15);

function timeAgo(dateStr: string) {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}
---

<Layout title="Command Center â€” The Far Mine">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <a href="/admin" class="text-sm text-copper hover:text-gold transition-colors">â† Dashboard</a>
        <h1 class="text-2xl font-display text-gold glow-text mt-2">ğŸ›ï¸ DevMaster Command Center</h1>
        <p class="text-copper-dark text-sm mt-1">Send prompts, upload files, and direct DevMaster from the web</p>
      </div>
    </div>

    <!-- Prompt Input -->
    <div class="card p-6 mb-6">
      <form id="prompt-form">
        <label class="text-sm font-heading text-copper block mb-2">Prompt</label>
        <textarea
          id="prompt-input"
          name="message"
          rows="6"
          class="w-full bg-mine-deep text-copper-light border border-copper-dark/30 rounded p-3 text-sm font-mono focus:border-gold focus:outline-none resize-y"
          placeholder="Type your message to DevMaster..."
        ></textarea>

        <!-- File Upload -->
        <div class="mt-3 flex items-center gap-4">
          <label class="text-xs text-copper-dark flex items-center gap-2 cursor-pointer hover:text-copper transition-colors">
            <span>ğŸ“ Attach files</span>
            <input type="file" id="file-input" multiple accept=".txt,.md,.json,.js,.ts,.css,.html,.xml,.yaml,.yml,.csv,.log,.py,.gd,.cfg,.ini,.toml,.png,.jpg,.jpeg,.gif,.webp,.svg" class="hidden" />
          </label>
          <div id="file-list" class="flex flex-wrap gap-2 text-[10px]"></div>
        </div>

        <!-- Submit -->
        <div class="mt-4 flex items-center gap-4">
          <button type="submit" id="submit-btn" class="btn-primary px-6 py-2 text-sm">
            Send to DevMaster
          </button>
          <span id="status-text" class="text-xs text-copper-dark"></span>
        </div>
      </form>
    </div>

    <!-- Response Area -->
    <div id="response-area" class="hidden mb-8">
      <h2 class="text-lg font-heading text-gold mb-3">ğŸ‘ï¸ DevMaster Response</h2>
      <div class="card p-5">
        <div id="response-status" class="text-xs text-copper-dark mb-2"></div>
        <pre id="response-content" class="text-sm text-copper-light whitespace-pre-wrap break-words max-h-[600px] overflow-y-auto"></pre>
      </div>
    </div>

    <!-- Prompt History -->
    <h2 class="text-lg font-heading text-gold mb-3">ğŸ“œ Recent Prompts</h2>
    <div class="space-y-3">
      {(!recentPrompts || recentPrompts.length === 0) ? (
        <div class="card p-6 text-center text-copper-dark text-sm">No prompts sent yet.</div>
      ) : recentPrompts.map(p => (
        <div class="card p-4 prompt-history-item cursor-pointer" data-id={p.id}>
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class={`w-2 h-2 rounded-full ${p.status === 'completed' ? 'bg-green-500' : p.status === 'failed' ? 'bg-forge-ember' : p.status === 'executing' ? 'bg-forge-warm animate-pulse' : 'bg-copper-dark animate-pulse'}`}></span>
              <span class="text-xs text-copper-dark">{p.status}</span>
            </div>
            <span class="text-[10px] text-copper-dark/40">{timeAgo(p.created_at)}</span>
          </div>
          <p class="text-xs text-copper-light/80 mb-1 truncate">{(p.params as any)?.message?.substring(0, 200) || 'No message'}</p>
          {p.result && (
            <div class="history-result hidden mt-2 bg-mine-deep/50 p-3 rounded border border-copper-dark/10">
              <pre class="text-xs text-copper-light/70 whitespace-pre-wrap break-words max-h-80 overflow-y-auto">{typeof p.result === 'string' ? p.result : JSON.stringify(p.result, null, 2)}</pre>
            </div>
          )}
        </div>
      ))}
    </div>
  </div>
</Layout>

<script>
  const form = document.getElementById('prompt-form') as HTMLFormElement;
  const input = document.getElementById('prompt-input') as HTMLTextAreaElement;
  const fileInput = document.getElementById('file-input') as HTMLInputElement;
  const fileList = document.getElementById('file-list') as HTMLElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const statusText = document.getElementById('status-text') as HTMLElement;
  const responseArea = document.getElementById('response-area') as HTMLElement;
  const responseStatus = document.getElementById('response-status') as HTMLElement;
  const responseContent = document.getElementById('response-content') as HTMLElement;

  let attachedFiles: { name: string; content: string; type: 'text' | 'image' }[] = [];

  // File handling
  fileInput.addEventListener('change', async () => {
    const files = fileInput.files;
    if (!files) return;

    for (const file of Array.from(files)) {
      const isImage = file.type.startsWith('image/');

      if (isImage) {
        // For images, we'd need Supabase Storage upload â€” for now, note them
        attachedFiles.push({ name: file.name, content: `[Image: ${file.name}]`, type: 'image' });
      } else {
        // Read text file content
        const text = await file.text();
        attachedFiles.push({ name: file.name, content: text.substring(0, 50000), type: 'text' });
      }

      const badge = document.createElement('span');
      badge.className = 'badge bg-mine-shaft text-copper-dark border border-copper-dark/30 px-2 py-0.5 rounded';
      badge.innerHTML = `${isImage ? 'ğŸ–¼ï¸' : 'ğŸ“„'} ${file.name} <button class="ml-1 text-forge-fire hover:text-forge-ember" data-name="${file.name}">Ã—</button>`;
      fileList.appendChild(badge);

      badge.querySelector('button')?.addEventListener('click', (e) => {
        const name = (e.target as HTMLElement).dataset.name;
        attachedFiles = attachedFiles.filter(f => f.name !== name);
        badge.remove();
      });
    }

    fileInput.value = '';
  });

  // Submit
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    let message = input.value.trim();
    if (!message && attachedFiles.length === 0) return;

    // Append text file content to the message
    const textFiles = attachedFiles.filter(f => f.type === 'text');
    if (textFiles.length > 0) {
      message += '\n\n--- ATTACHED FILES ---';
      for (const f of textFiles) {
        message += `\n\nğŸ“„ FILE: ${f.name}\n${f.content}`;
      }
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';
    statusText.textContent = 'Submitting prompt to DevMaster...';

    try {
      const res = await fetch('/admin/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          command: 'prompt',
          params: { message }
        })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to submit');

      const commandId = data.id;
      statusText.textContent = 'Prompt queued. Waiting for DevMaster (polling every 5s)...';

      // Show response area
      responseArea.classList.remove('hidden');
      responseStatus.textContent = 'â³ Waiting for DevMaster to process...';
      responseContent.textContent = '';

      // Poll for result
      let attempts = 0;
      const maxAttempts = 60; // 5 minutes max
      const pollInterval = setInterval(async () => {
        attempts++;
        try {
          const statusRes = await fetch(`/admin/api/command-status?id=${commandId}`);
          const statusData = await statusRes.json();

          if (statusData.status === 'completed') {
            clearInterval(pollInterval);
            responseStatus.textContent = `âœ… Completed ${statusData.executed_at ? 'â€” ' + new Date(statusData.executed_at).toLocaleTimeString() : ''}`;
            responseContent.textContent = typeof statusData.result === 'string' ? statusData.result : JSON.stringify(statusData.result, null, 2);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send to DevMaster';
            statusText.textContent = '';
          } else if (statusData.status === 'failed') {
            clearInterval(pollInterval);
            responseStatus.textContent = 'âŒ Failed';
            responseContent.textContent = statusData.result || 'Unknown error';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send to DevMaster';
            statusText.textContent = '';
          } else if (statusData.status === 'executing') {
            responseStatus.textContent = 'âš™ï¸ DevMaster is processing...';
          } else {
            responseStatus.textContent = `â³ Queued (poll ${attempts}/${maxAttempts})...`;
          }

          if (attempts >= maxAttempts) {
            clearInterval(pollInterval);
            responseStatus.textContent = 'â° Timed out â€” check back in a moment';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send to DevMaster';
            statusText.textContent = '';
          }
        } catch {
          // Ignore transient fetch errors
        }
      }, 5000);

    } catch (err: any) {
      statusText.textContent = `Error: ${err.message}`;
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send to DevMaster';
    }
  });

  // Toggle history items
  document.querySelectorAll('.prompt-history-item').forEach(item => {
    item.addEventListener('click', () => {
      const result = item.querySelector('.history-result');
      if (result) result.classList.toggle('hidden');
    });
  });
</script>
