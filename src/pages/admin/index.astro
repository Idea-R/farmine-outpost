---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import AdminNav from '../../components/AdminNav.astro';
import { supabase } from '../../lib/supabase';

// Fetch dashboard data in parallel
const now = new Date();
const todayStart = new Date(now); todayStart.setHours(0,0,0,0);
const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();

const [
  { data: agents },
  { data: cycleLogs },
  { data: todaySpend },
  { data: weekSpend },
  { data: pendingTasks },
  { data: recentCommands },
  { data: rapportData },
  { data: recentBlackboard },
  { data: completedTasks24h },
  { data: pendingEscalations },
] = await Promise.all([
  supabase.from('agent_souls').select('agent_id, dwarven_name, display_name, specialization, emoji, mood').order('agent_id'),
  supabase.from('cycle_log').select('*').order('created_at', { ascending: false }).limit(25),
  supabase.from('api_spend').select('estimated_cost').gte('created_at', todayStart.toISOString()),
  supabase.from('api_spend').select('estimated_cost').gte('created_at', weekStart.toISOString()),
  supabase.from('task_ledger').select('id, assigned_to, task_description, status, priority').in('status', ['assigned', 'in_progress']).order('priority', { ascending: false }).limit(10),
  supabase.from('admin_commands').select('*').order('created_at', { ascending: false }).limit(5),
  supabase.from('rapport_matrix').select('agent_a, agent_b, rapport_score, trust_level, total_collaborations, last_interaction_at').order('rapport_score', { ascending: false }),
  supabase.from('blackboard').select('id, agent_id, entry_type, content, created_at').gte('created_at', last24h).order('created_at', { ascending: false }),
  supabase.from('task_ledger').select('id, assigned_to, task_description, status').eq('status', 'completed').gte('updated_at', last24h).order('updated_at', { ascending: false }),
  supabase.from('blackboard').select('id, agent_id, entry_type, content, created_at').in('entry_type', ['question', 'request', 'escalation', 'blocker']).in('status', ['active', 'pending']).order('created_at', { ascending: false }).limit(10),
]);

// Aggregate 24h blackboard by type
const bb24h = recentBlackboard || [];
const bbByType: Record<string, number> = {};
for (const entry of bb24h) {
  bbByType[entry.entry_type] = (bbByType[entry.entry_type] || 0) + 1;
}
const deliverables24h = bb24h.filter(e => e.entry_type === 'deliverable' || (e.content && e.content.includes('File created')));

const todayTotal = (todaySpend || []).reduce((s, r) => s + (r.estimated_cost || 0), 0);
const weekTotal = (weekSpend || []).reduce((s, r) => s + (r.estimated_cost || 0), 0);

function timeAgo(dateStr: string) {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}

const agentEmojis: Record<string, string> = {
  alpha: 'ğŸ—ï¸', beta: 'ğŸŒ', gamma: 'âš”ï¸', delta: 'ğŸ”§',
  epsilon: 'ğŸ“–', zeta: 'ğŸµ', eta: 'ğŸ¨', theta: 'ğŸº', dev_master: 'ğŸ‘ï¸'
};
---

<Layout title="Admin Dashboard â€” The Far Mine">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <AdminNav current="dashboard" title="â›ï¸ Command Chamber" subtitle="Operational overview of The Far Mine orchestra" />

    <!-- Spend Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
      <div class="card p-4 text-center">
        <div class="text-xs text-copper-dark mb-1">Today's Spend</div>
        <div class={`text-2xl font-heading ${todayTotal > 5 ? 'text-forge-fire' : todayTotal > 1 ? 'text-copper' : 'text-gold'}`}>
          ${todayTotal.toFixed(4)}
        </div>
      </div>
      <div class="card p-4 text-center">
        <div class="text-xs text-copper-dark mb-1">This Week</div>
        <div class="text-2xl font-heading text-gold">${weekTotal.toFixed(4)}</div>
      </div>
      <div class="card p-4 text-center">
        <div class="text-xs text-copper-dark mb-1">Active Tasks</div>
        <div class="text-2xl font-heading text-copper">{(pendingTasks || []).length}</div>
      </div>
    </div>

    <!-- What's New 24h -->
    <div class="card p-5 mb-8">
      <h2 class="text-lg font-heading text-gold mb-3">ğŸ†• What's New (Last 24h)</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-3">
        <div>
          <div class="text-xs text-copper-dark mb-1">Blackboard Entries</div>
          <div class="text-xl font-heading text-copper">{bb24h.length}</div>
          {Object.keys(bbByType).length > 0 && (
            <div class="flex flex-wrap gap-1 mt-1">
              {Object.entries(bbByType).map(([type, count]) => (
                <span class="text-[10px] px-1.5 py-0.5 rounded bg-mine-shaft border border-copper-dark/20 text-copper-dark">
                  {type}: {count}
                </span>
              ))}
            </div>
          )}
        </div>
        <div>
          <div class="text-xs text-copper-dark mb-1">Deliverables</div>
          <div class="text-xl font-heading text-copper">{deliverables24h.length}</div>
          {deliverables24h.length > 0 && (
            <div class="mt-1 space-y-0.5">
              {deliverables24h.slice(0, 3).map(d => (
                <p class="text-[10px] text-copper-dark/70 truncate">
                  {agentEmojis[d.agent_id] || 'ğŸ¤–'} {d.content?.slice(0, 60)}
                </p>
              ))}
              {deliverables24h.length > 3 && <p class="text-[10px] text-copper-dark/40">+{deliverables24h.length - 3} more</p>}
            </div>
          )}
        </div>
        <div>
          <div class="text-xs text-copper-dark mb-1">Tasks Completed</div>
          <div class="text-xl font-heading text-copper">{(completedTasks24h || []).length}</div>
          {(completedTasks24h || []).length > 0 && (
            <div class="mt-1 space-y-0.5">
              {(completedTasks24h || []).slice(0, 3).map(t => (
                <p class="text-[10px] text-copper-dark/70 truncate">
                  {agentEmojis[t.assigned_to] || 'ğŸ¤–'} {t.task_description?.slice(0, 60)}
                </p>
              ))}
            </div>
          )}
        </div>
      </div>
      {(pendingEscalations && pendingEscalations.length > 0) && (
        <div class="border-t border-copper-dark/20 pt-3 mt-2">
          <div class="text-xs text-forge-fire mb-1">âš ï¸ Pending Escalations / Blockers ({pendingEscalations.length})</div>
          <div class="space-y-1">
            {pendingEscalations.slice(0, 5).map(e => (
              <div class="flex items-center gap-2 text-xs">
                <span>{agentEmojis[e.agent_id] || 'ğŸ¤–'}</span>
                <span class="badge bg-forge-ember/20 text-forge-fire text-[10px] px-1">{e.entry_type}</span>
                <span class="text-copper-dark/70 truncate">{e.content?.slice(0, 80)}</span>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>

    <!-- Agent Grid -->
    <h2 class="text-xl font-heading text-gold mb-4">ğŸ¤– Agent Swarm</h2>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-8">
      {(agents || []).map(agent => {
        const recentAction = (cycleLogs || []).find(l => l.agent_id === agent.agent_id);
        return (
          <a href={`/admin/agents/${agent.agent_id}`} class="card-hover p-4 block">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-lg">{agentEmojis[agent.agent_id] || 'ğŸ¤–'}</span>
              <span class="font-heading text-sm text-gold truncate">{agent.dwarven_name || agent.display_name}</span>
            </div>
            <div class="text-xs text-copper-dark mb-1">{agent.specialization}</div>
            <div class="text-xs text-copper-dark/60">
              {agent.mood && <span class="badge-mood text-[10px] mr-1">{agent.mood}</span>}
              {recentAction ? (
                <span>{recentAction.action} Â· {timeAgo(recentAction.created_at)}</span>
              ) : (
                <span>No recent activity</span>
              )}
            </div>
          </a>
        );
      })}
    </div>

    <!-- DevMaster Status -->
    {(() => {
      const dmLog = (cycleLogs || []).find(l => l.cycle_type === 'devmaster_cycle');
      return (
        <div class="card p-5 mb-8">
          <h2 class="text-lg font-heading text-gold mb-3">ğŸ‘ï¸ DevMaster â€” Last Strategic Cycle</h2>
          {dmLog ? (
            <div>
              <p class="text-sm text-copper-light mb-1">{dmLog.reasoning || 'No assessment available'}</p>
              <p class="text-xs text-copper-dark">Action: {dmLog.action} Â· {timeAgo(dmLog.created_at)} Â· Model: {dmLog.model_used || 'unknown'}</p>
            </div>
          ) : (
            <p class="text-sm text-copper-dark">No DevMaster cycle data yet.</p>
          )}
        </div>
      );
    })()}

    <!-- Rapport Matrix -->
    {(rapportData && rapportData.length > 0) && (
      <div class="mb-8">
        <h2 class="text-xl font-heading text-gold mb-4">ğŸ¤ Agent Rapport</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {rapportData.map(r => {
            const scoreColor = r.rapport_score >= 50 ? 'text-green-400' : r.rapport_score >= 20 ? 'text-copper' : r.rapport_score >= 0 ? 'text-copper-dark' : 'text-forge-fire';
            const trustBadge = { high: 'bg-green-900/50 text-green-400', medium: 'bg-copper-dark/20 text-copper', low: 'bg-forge-ember/20 text-forge-fire' }[r.trust_level] || 'bg-mine-shaft text-copper-dark';
            return (
              <div class="card p-3 flex items-center gap-3">
                <div class="flex items-center gap-1 text-sm shrink-0">
                  <span>{agentEmojis[r.agent_a] || 'ğŸ¤–'}</span>
                  <span class="text-copper-dark/50">â†’</span>
                  <span>{agentEmojis[r.agent_b] || 'ğŸ¤–'}</span>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 text-xs">
                    <span class="font-heading text-copper">{r.agent_a}</span>
                    <span class="text-copper-dark/40">&amp;</span>
                    <span class="font-heading text-copper">{r.agent_b}</span>
                  </div>
                  <div class="flex items-center gap-2 text-[10px] mt-0.5">
                    <span class={scoreColor}>Score: {r.rapport_score}</span>
                    <span class={`badge px-1 py-0 rounded ${trustBadge}`}>{r.trust_level}</span>
                    <span class="text-copper-dark/40">{r.total_collaborations} collab{r.total_collaborations !== 1 ? 's' : ''}</span>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    )}

    <!-- Recent Activity Feed -->
    <h2 class="text-xl font-heading text-gold mb-4">ğŸ“‹ Recent Cycle Activity</h2>
    <div class="card p-4 mb-8">
      {(!cycleLogs || cycleLogs.length === 0) ? (
        <p class="text-copper-dark text-center py-4">No cycle data yet. Agents will start logging soon.</p>
      ) : (
        <div class="space-y-2 max-h-96 overflow-y-auto">
          {cycleLogs.map(log => (
            <div class="flex items-start gap-3 py-2 border-b border-copper-dark/10 last:border-0">
              <span class="text-sm shrink-0">{agentEmojis[log.agent_id] || 'ğŸ¤–'}</span>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 text-xs">
                  <span class="font-heading text-copper">{log.agent_id}</span>
                  <span class="badge bg-mine-shaft text-copper-dark border border-copper-dark/30 text-[10px]">{log.action}</span>
                  <span class="text-copper-dark/50 ml-auto shrink-0">{timeAgo(log.created_at)}</span>
                </div>
                {log.reasoning && (
                  <p class="text-xs text-copper-dark/70 mt-0.5 truncate">{log.reasoning}</p>
                )}
                {log.result_summary && (
                  <p class="text-xs text-copper-light/60 mt-0.5 truncate">{log.result_summary}</p>
                )}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>

    <!-- Recent Admin Commands -->
    {(recentCommands && recentCommands.length > 0) && (
      <div class="card p-4">
        <h2 class="text-lg font-heading text-gold mb-3">ğŸ›ï¸ Recent Commands</h2>
        <div class="space-y-1">
          {recentCommands.map(cmd => (
            <div class="flex items-center justify-between text-xs py-1 border-b border-copper-dark/10 last:border-0">
              <div class="flex items-center gap-2">
                <span class={`w-2 h-2 rounded-full ${cmd.status === 'completed' ? 'bg-green-500' : cmd.status === 'failed' ? 'bg-forge-ember' : cmd.status === 'executing' ? 'bg-forge-warm' : 'bg-copper-dark'}`}></span>
                <span class="text-copper-light">{cmd.command}</span>
                {cmd.target && <span class="text-copper-dark">â†’ {cmd.target}</span>}
              </div>
              <div class="flex items-center gap-2">
                <span class="text-copper-dark/50">{cmd.status}</span>
                <span class="text-copper-dark/40">{timeAgo(cmd.created_at)}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}
  </div>
</Layout>
