---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import AdminNav from '../../components/AdminNav.astro';
import { supabase } from '../../lib/supabase';

// Parse query params for filtering
const url = new URL(Astro.request.url);
const filterAgent = url.searchParams.get('agent') || '';
const filterType = url.searchParams.get('type') || '';
const filterStatus = url.searchParams.get('status') || '';
const filterSearch = url.searchParams.get('q') || '';
const filesOnly = url.searchParams.get('files') === '1';
const viewMode = url.searchParams.get('view') || 'feed'; // 'feed' | 'registry'
const sortBy = url.searchParams.get('sort') || 'date'; // 'date' | 'agent' | 'type'
const page = parseInt(url.searchParams.get('page') || '1');
const perPage = 25;

// Build query
let query = supabase
  .from('shared_blackboard')
  .select('id, posted_by, entry_type, content, status, created_at, claimed_by, view_count', { count: 'exact' })
  .order('created_at', { ascending: false });

if (filterAgent) query = query.eq('posted_by', filterAgent);
if (filterType) query = query.eq('entry_type', filterType);
if (filterStatus) query = query.eq('status', filterStatus);
if (filterSearch) query = query.ilike('content', `%${filterSearch}%`);
if (filesOnly) query = query.ilike('content', 'File created:%');

query = query.range((page - 1) * perPage, page * perPage - 1);

const { data: entries, count: totalCount } = await query;

// Registry: fetch file deliverables separately when in registry view
let registryEntries: any[] = [];
if (viewMode === 'registry') {
  let regQuery = supabase
    .from('shared_blackboard')
    .select('id, posted_by, entry_type, content, status, created_at')
    .ilike('content', 'File created:%')
    .order(sortBy === 'agent' ? 'posted_by' : sortBy === 'type' ? 'entry_type' : 'created_at', { ascending: sortBy !== 'date' });
  if (filterAgent) regQuery = regQuery.eq('posted_by', filterAgent);
  const { data: regData } = await regQuery;
  registryEntries = (regData || []).map(e => {
    const parts = e.content.replace('File created:', '').split('â€”');
    return {
      ...e,
      fileName: parts[0]?.trim() || 'unknown',
      description: parts.slice(1).join('â€”').trim() || '',
    };
  });
}

// Get distinct agents, types, and statuses for filter dropdowns
const [{ data: agentList }, { data: typeList }, { data: statusList }] = await Promise.all([
  supabase.from('shared_blackboard').select('posted_by').order('posted_by'),
  supabase.from('shared_blackboard').select('entry_type').order('entry_type'),
  supabase.from('shared_blackboard').select('status').order('status'),
]);

const uniqueAgents = [...new Set((agentList || []).map(a => a.posted_by))];
const uniqueTypes = [...new Set((typeList || []).map(t => t.entry_type))];
const uniqueStatuses = [...new Set((statusList || []).map(s => s.status))];
const totalPages = Math.ceil((totalCount || 0) / perPage);

// Build query string helper for pagination links
function buildQs(p: number, overrides: Record<string, string> = {}) {
  const params = new URLSearchParams();
  params.set('page', String(p));
  if (filterAgent) params.set('agent', filterAgent);
  if (filterType) params.set('type', filterType);
  if (filterStatus) params.set('status', filterStatus);
  if (filterSearch) params.set('q', filterSearch);
  if (filesOnly) params.set('files', '1');
  const v = overrides.view ?? viewMode;
  if (v !== 'feed') params.set('view', v);
  const s = overrides.sort ?? sortBy;
  if (s !== 'date') params.set('sort', s);
  for (const [k, val] of Object.entries(overrides)) {
    if (k !== 'view' && k !== 'sort') params.set(k, val);
  }
  return params.toString();
}
const hasFilters = !!(filterAgent || filterType || filterStatus || filterSearch || filesOnly);

const agentEmojis: Record<string, string> = {
  alpha: 'ğŸ—ï¸', beta: 'ğŸŒ', gamma: 'âš”ï¸', delta: 'ğŸ”§',
  epsilon: 'ğŸ“–', zeta: 'ğŸµ', eta: 'ğŸ¨', theta: 'ğŸº', dev_master: 'ğŸ‘ï¸'
};

const typeIcons: Record<string, string> = {
  knowledge: 'ğŸ“„', observation: 'ğŸ‘€', request: 'ğŸ“¨',
  question: 'â“', decision: 'âš–ï¸', announcement: 'ğŸ“¢'
};

function timeAgo(dateStr: string) {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}

function isFileDeliverable(content: string) {
  return content?.startsWith('File created:');
}
---

<Layout title="Assets & Deliverables â€” The Far Mine">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <AdminNav current="assets" title="ğŸ“¦ Assets & Deliverables" subtitle={`${totalCount || 0} blackboard entries from the agent swarm`} />

    <!-- View Toggle -->
    <div class="flex items-center gap-2 mb-4">
      <a href={`/admin/assets?${buildQs(1, { view: 'feed' })}`}
         class={`text-xs px-3 py-1.5 rounded border transition-all ${viewMode === 'feed' ? 'border-copper text-gold bg-mine-stone' : 'border-copper-dark/30 text-copper-dark hover:border-copper/50'}`}>
        ğŸ“‹ Feed View
      </a>
      <a href={`/admin/assets?${buildQs(1, { view: 'registry' })}`}
         class={`text-xs px-3 py-1.5 rounded border transition-all ${viewMode === 'registry' ? 'border-copper text-gold bg-mine-stone' : 'border-copper-dark/30 text-copper-dark hover:border-copper/50'}`}>
        ğŸ“ Deliverable Registry
      </a>
    </div>

    <!-- Filters -->
    <div class="card p-4 mb-6">
      <form method="GET" action="/admin/assets" class="flex flex-wrap items-center gap-3">
        <!-- Text search -->
        <div class="w-full sm:w-auto flex-1 min-w-[200px]">
          <input type="text" name="q" value={filterSearch} placeholder="Search content..." class="w-full bg-mine-deep text-copper-light border border-copper-dark/30 rounded px-3 py-1 text-xs focus:border-gold focus:outline-none" />
        </div>

        <select name="agent" class="bg-mine-deep text-copper border border-copper-dark/30 rounded px-2 py-1 text-xs">
          <option value="">All agents</option>
          {uniqueAgents.map(a => (
            <option value={a} selected={a === filterAgent}>{agentEmojis[a] || 'ğŸ¤–'} {a}</option>
          ))}
        </select>

        <select name="type" class="bg-mine-deep text-copper border border-copper-dark/30 rounded px-2 py-1 text-xs">
          <option value="">All types</option>
          {uniqueTypes.map(t => (
            <option value={t} selected={t === filterType}>{typeIcons[t] || 'ğŸ“‹'} {t}</option>
          ))}
        </select>

        <select name="status" class="bg-mine-deep text-copper border border-copper-dark/30 rounded px-2 py-1 text-xs">
          <option value="">All statuses</option>
          {uniqueStatuses.map(s => (
            <option value={s} selected={s === filterStatus}>{s}</option>
          ))}
        </select>

        <label class="flex items-center gap-1 text-xs text-copper-dark cursor-pointer">
          <input type="checkbox" name="files" value="1" checked={filesOnly} class="accent-gold" />
          ğŸ“ Files only
        </label>

        <button type="submit" class="btn-primary text-xs px-3 py-1">Search</button>
        {hasFilters && (
          <a href="/admin/assets" class="text-xs text-copper-dark hover:text-forge-fire">Clear</a>
        )}
      </form>
    </div>

    <!-- Registry View -->
    {viewMode === 'registry' && (
      <div class="card p-4 mb-6">
        <div class="flex items-center gap-3 mb-3">
          <span class="text-xs text-copper-dark">Sort by:</span>
          <a href={`/admin/assets?${buildQs(1, { view: 'registry', sort: 'date' })}`}
             class={`text-xs px-2 py-1 rounded border transition-all ${sortBy === 'date' ? 'border-copper text-gold bg-mine-stone' : 'border-copper-dark/30 text-copper-dark hover:border-copper/50'}`}>Date</a>
          <a href={`/admin/assets?${buildQs(1, { view: 'registry', sort: 'agent' })}`}
             class={`text-xs px-2 py-1 rounded border transition-all ${sortBy === 'agent' ? 'border-copper text-gold bg-mine-stone' : 'border-copper-dark/30 text-copper-dark hover:border-copper/50'}`}>Agent</a>
          <a href={`/admin/assets?${buildQs(1, { view: 'registry', sort: 'type' })}`}
             class={`text-xs px-2 py-1 rounded border transition-all ${sortBy === 'type' ? 'border-copper text-gold bg-mine-stone' : 'border-copper-dark/30 text-copper-dark hover:border-copper/50'}`}>Type</a>
          <span class="text-xs text-copper-dark/40 ml-auto">{registryEntries.length} files</span>
        </div>
        {registryEntries.length === 0 ? (
          <p class="text-copper-dark text-center py-4">No file deliverables found.</p>
        ) : (
          <div class="overflow-x-auto">
            <div class="min-w-[600px]">
              <div class="grid grid-cols-[auto_1fr_auto_auto] gap-x-4 gap-y-0 text-[10px] text-copper-dark font-heading uppercase tracking-wider border-b border-copper-dark/20 pb-1 mb-1">
                <span>Agent</span><span>Filename</span><span>Type</span><span>Date</span>
              </div>
              {registryEntries.map(r => (
                <div class="grid grid-cols-[auto_1fr_auto_auto] gap-x-4 gap-y-0 text-xs py-1.5 border-b border-copper-dark/10 last:border-0 hover:bg-mine-shaft/30">
                  <span class="flex items-center gap-1">
                    <span>{agentEmojis[r.posted_by] || 'ğŸ¤–'}</span>
                    <span class="text-copper">{r.posted_by}</span>
                  </span>
                  <span class="text-green-400 truncate" title={r.fileName}>ğŸ“ {r.fileName}</span>
                  <span class="badge bg-mine-shaft text-copper-dark border border-copper-dark/30 text-[10px]">{r.entry_type}</span>
                  <span class="text-copper-dark/50">{timeAgo(r.created_at)}</span>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    )}

    <!-- Feed View (Entry List) -->
    {viewMode === 'feed' && <div class="space-y-3">
      {(!entries || entries.length === 0) ? (
        <div class="card p-8 text-center text-copper-dark">No entries found.</div>
      ) : entries.map(entry => {
        const isFile = isFileDeliverable(entry.content);
        const fileName = isFile ? entry.content.split('â€”')[0].replace('File created:', '').trim() : null;
        const preview = (entry.content || '').substring(0, 400);

        return (
          <div class="card p-4 group" id={`entry-${entry.id}`}>
            <div class="flex items-start gap-3">
              <!-- Agent + Type badges -->
              <div class="shrink-0 text-center" style="min-width: 48px;">
                <span class="text-lg">{agentEmojis[entry.posted_by] || 'ğŸ¤–'}</span>
                <div class="text-[10px] text-copper-dark font-heading mt-0.5">{entry.posted_by}</div>
              </div>

              <div class="flex-1 min-w-0">
                <!-- Header row -->
                <div class="flex items-center gap-2 flex-wrap mb-1">
                  <span class="badge bg-mine-shaft text-copper-dark border border-copper-dark/30 text-[10px]">
                    {typeIcons[entry.entry_type] || 'ğŸ“‹'} {entry.entry_type}
                  </span>
                  {isFile && (
                    <span class="badge bg-green-900/30 text-green-400 border border-green-800/30 text-[10px]">
                      ğŸ“ {fileName}
                    </span>
                  )}
                  <span class={`text-[10px] ${entry.status === 'active' ? 'text-green-400' : 'text-copper-dark/50'}`}>
                    {entry.status}
                  </span>
                  {entry.claimed_by && (
                    <span class="text-[10px] text-copper-dark/50">claimed by {entry.claimed_by}</span>
                  )}
                  <span class="text-[10px] text-copper-dark/40 ml-auto shrink-0">{timeAgo(entry.created_at)}</span>
                </div>

                <!-- Content preview -->
                <div class="asset-content">
                  <p class="text-xs text-copper-light/70 whitespace-pre-wrap break-words content-preview">{preview}{(entry.content || '').length > 400 ? 'â€¦' : ''}</p>
                  {(entry.content || '').length > 400 && (
                    <div>
                      <pre class="text-xs text-copper-light/70 whitespace-pre-wrap break-words content-full hidden mt-2 bg-mine-deep/50 p-3 rounded border border-copper-dark/10 max-h-96 overflow-y-auto">{entry.content}</pre>
                      <button class="expand-btn text-[10px] text-copper hover:text-gold mt-1 cursor-pointer">Show full content â–¼</button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      })}
    </div>}

    <!-- Pagination (feed view only) -->
    {viewMode === 'feed' && totalPages > 1 && (
      <div class="flex items-center justify-center gap-2 mt-8">
        {page > 1 && (
          <a href={`/admin/assets?${buildQs(page - 1)}`}
             class="text-sm text-copper hover:text-gold px-3 py-1 card-hover">â† Prev</a>
        )}
        <span class="text-xs text-copper-dark">Page {page} of {totalPages}</span>
        {page < totalPages && (
          <a href={`/admin/assets?${buildQs(page + 1)}`}
             class="text-sm text-copper hover:text-gold px-3 py-1 card-hover">Next â†’</a>
        )}
      </div>
    )}
  </div>
</Layout>

<script>
  document.querySelectorAll('.expand-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const container = btn.closest('.asset-content');
      if (!container) return;
      const preview = container.querySelector('.content-preview') as HTMLElement;
      const full = container.querySelector('.content-full') as HTMLElement;
      if (!preview || !full) return;

      const isExpanded = !full.classList.contains('hidden');
      full.classList.toggle('hidden');
      preview.classList.toggle('hidden');
      btn.textContent = isExpanded ? 'Show full content â–¼' : 'Collapse â–²';
    });
  });
</script>
