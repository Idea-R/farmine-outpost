---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

// Parse query params for filtering
const url = new URL(Astro.request.url);
const filterAgent = url.searchParams.get('agent') || '';
const filterType = url.searchParams.get('type') || '';
const page = parseInt(url.searchParams.get('page') || '1');
const perPage = 25;

// Build query
let query = supabase
  .from('shared_blackboard')
  .select('id, posted_by, entry_type, content, status, created_at, claimed_by, view_count', { count: 'exact' })
  .order('created_at', { ascending: false });

if (filterAgent) query = query.eq('posted_by', filterAgent);
if (filterType) query = query.eq('entry_type', filterType);

query = query.range((page - 1) * perPage, page * perPage - 1);

const { data: entries, count: totalCount } = await query;

// Get distinct agents and types for filter dropdowns
const [{ data: agentList }, { data: typeList }] = await Promise.all([
  supabase.from('shared_blackboard').select('posted_by').order('posted_by'),
  supabase.from('shared_blackboard').select('entry_type').order('entry_type'),
]);

const uniqueAgents = [...new Set((agentList || []).map(a => a.posted_by))];
const uniqueTypes = [...new Set((typeList || []).map(t => t.entry_type))];
const totalPages = Math.ceil((totalCount || 0) / perPage);

const agentEmojis: Record<string, string> = {
  alpha: 'ğŸ—ï¸', beta: 'ğŸŒ', gamma: 'âš”ï¸', delta: 'ğŸ”§',
  epsilon: 'ğŸ“–', zeta: 'ğŸµ', eta: 'ğŸ¨', theta: 'ğŸº', dev_master: 'ğŸ‘ï¸'
};

const typeIcons: Record<string, string> = {
  knowledge: 'ğŸ“„', observation: 'ğŸ‘€', request: 'ğŸ“¨',
  question: 'â“', decision: 'âš–ï¸', announcement: 'ğŸ“¢'
};

function timeAgo(dateStr: string) {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}

function isFileDeliverable(content: string) {
  return content?.startsWith('File created:');
}
---

<Layout title="Assets & Deliverables â€” The Far Mine">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <a href="/admin" class="text-sm text-copper hover:text-gold transition-colors">â† Dashboard</a>
        <h1 class="text-2xl font-display text-gold glow-text mt-2">ğŸ“¦ Assets & Deliverables</h1>
        <p class="text-copper-dark text-sm mt-1">{totalCount || 0} blackboard entries from the agent swarm</p>
      </div>
    </div>

    <!-- Filters -->
    <div class="card p-4 mb-6 flex flex-wrap items-center gap-4">
      <form method="GET" action="/admin/assets" class="flex flex-wrap items-center gap-3">
        <label class="text-xs text-copper-dark">Agent:</label>
        <select name="agent" class="bg-mine-deep text-copper border border-copper-dark/30 rounded px-2 py-1 text-xs">
          <option value="">All agents</option>
          {uniqueAgents.map(a => (
            <option value={a} selected={a === filterAgent}>{agentEmojis[a] || 'ğŸ¤–'} {a}</option>
          ))}
        </select>

        <label class="text-xs text-copper-dark">Type:</label>
        <select name="type" class="bg-mine-deep text-copper border border-copper-dark/30 rounded px-2 py-1 text-xs">
          <option value="">All types</option>
          {uniqueTypes.map(t => (
            <option value={t} selected={t === filterType}>{typeIcons[t] || 'ğŸ“‹'} {t}</option>
          ))}
        </select>

        <button type="submit" class="btn-primary text-xs px-3 py-1">Filter</button>
        {(filterAgent || filterType) && (
          <a href="/admin/assets" class="text-xs text-copper-dark hover:text-forge-fire">Clear</a>
        )}
      </form>
    </div>

    <!-- Entry List -->
    <div class="space-y-3">
      {(!entries || entries.length === 0) ? (
        <div class="card p-8 text-center text-copper-dark">No entries found.</div>
      ) : entries.map(entry => {
        const isFile = isFileDeliverable(entry.content);
        const fileName = isFile ? entry.content.split('â€”')[0].replace('File created:', '').trim() : null;
        const preview = (entry.content || '').substring(0, 400);

        return (
          <div class="card p-4 group" id={`entry-${entry.id}`}>
            <div class="flex items-start gap-3">
              <!-- Agent + Type badges -->
              <div class="shrink-0 text-center" style="min-width: 48px;">
                <span class="text-lg">{agentEmojis[entry.posted_by] || 'ğŸ¤–'}</span>
                <div class="text-[10px] text-copper-dark font-heading mt-0.5">{entry.posted_by}</div>
              </div>

              <div class="flex-1 min-w-0">
                <!-- Header row -->
                <div class="flex items-center gap-2 flex-wrap mb-1">
                  <span class="badge bg-mine-shaft text-copper-dark border border-copper-dark/30 text-[10px]">
                    {typeIcons[entry.entry_type] || 'ğŸ“‹'} {entry.entry_type}
                  </span>
                  {isFile && (
                    <span class="badge bg-green-900/30 text-green-400 border border-green-800/30 text-[10px]">
                      ğŸ“ {fileName}
                    </span>
                  )}
                  <span class={`text-[10px] ${entry.status === 'active' ? 'text-green-400' : 'text-copper-dark/50'}`}>
                    {entry.status}
                  </span>
                  {entry.claimed_by && (
                    <span class="text-[10px] text-copper-dark/50">claimed by {entry.claimed_by}</span>
                  )}
                  <span class="text-[10px] text-copper-dark/40 ml-auto shrink-0">{timeAgo(entry.created_at)}</span>
                </div>

                <!-- Content preview -->
                <div class="asset-content">
                  <p class="text-xs text-copper-light/70 whitespace-pre-wrap break-words content-preview">{preview}{(entry.content || '').length > 400 ? 'â€¦' : ''}</p>
                  {(entry.content || '').length > 400 && (
                    <div>
                      <pre class="text-xs text-copper-light/70 whitespace-pre-wrap break-words content-full hidden mt-2 bg-mine-deep/50 p-3 rounded border border-copper-dark/10 max-h-96 overflow-y-auto">{entry.content}</pre>
                      <button class="expand-btn text-[10px] text-copper hover:text-gold mt-1 cursor-pointer">Show full content â–¼</button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      })}
    </div>

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="flex items-center justify-center gap-2 mt-8">
        {page > 1 && (
          <a href={`/admin/assets?page=${page - 1}${filterAgent ? `&agent=${filterAgent}` : ''}${filterType ? `&type=${filterType}` : ''}`}
             class="text-sm text-copper hover:text-gold px-3 py-1 card-hover">â† Prev</a>
        )}
        <span class="text-xs text-copper-dark">Page {page} of {totalPages}</span>
        {page < totalPages && (
          <a href={`/admin/assets?page=${page + 1}${filterAgent ? `&agent=${filterAgent}` : ''}${filterType ? `&type=${filterType}` : ''}`}
             class="text-sm text-copper hover:text-gold px-3 py-1 card-hover">Next â†’</a>
        )}
      </div>
    )}
  </div>
</Layout>

<script>
  document.querySelectorAll('.expand-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const container = btn.closest('.asset-content');
      if (!container) return;
      const preview = container.querySelector('.content-preview') as HTMLElement;
      const full = container.querySelector('.content-full') as HTMLElement;
      if (!preview || !full) return;

      const isExpanded = !full.classList.contains('hidden');
      full.classList.toggle('hidden');
      preview.classList.toggle('hidden');
      btn.textContent = isExpanded ? 'Show full content â–¼' : 'Collapse â–²';
    });
  });
</script>
